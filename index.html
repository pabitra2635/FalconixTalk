<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FalconixTalk - WhatsApp Style</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base styles for light and dark mode */
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #ECE5DD; /* Light mode page background */
        }
        .dark body {
            background-color: #111B21; /* Dark mode page background */
        }
        .chat-area-bg {
            background-color: #ECE5DD; /* Light mode chat background */
        }
        .dark .chat-area-bg {
            background-color: #0b141a; /* Dark mode chat background */
        }

        /* Custom scrollbars for light mode */
        .chat-messages::-webkit-scrollbar, .chat-list::-webkit-scrollbar { width: 8px; }
        .chat-messages::-webkit-scrollbar-track, .chat-list::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .chat-messages::-webkit-scrollbar-thumb, .chat-list::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        .chat-messages::-webkit-scrollbar-thumb:hover, .chat-list::-webkit-scrollbar-thumb:hover { background: #555; }

        /* Custom scrollbars for dark mode */
        .dark .chat-messages::-webkit-scrollbar-track, .dark .chat-list::-webkit-scrollbar-track { background: #202c33; }
        .dark .chat-messages::-webkit-scrollbar-thumb, .dark .chat-list::-webkit-scrollbar-thumb { background: #374045; }
        .dark .chat-messages::-webkit-scrollbar-thumb:hover, .dark .chat-list::-webkit-scrollbar-thumb:hover { background: #4b555b; }

        /* Loading spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #128C7E;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        .dark .spinner { border-left-color: #25D366; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Message bubble animations */
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.3s ease-out; }

        /* Responsive adjustments for smaller screens */
        @media (max-width: 767px) {
            /* Make app container full screen on mobile */
            #app-container {
                flex-direction: column;
                width: 100%;
                height: 100%;
                max-height: 100vh;
                border-radius: 0;
            }
            #app-container > div:first-child { /* Sidebar */
                width: 100%;
                height: 100%;
                border-right: none;
                border-bottom: 1px solid #d1d5db;
            }
            .dark #app-container > div:first-child {
                border-bottom: 1px solid #374045;
            }
            #app-container > div:last-child { /* Chat Area */
                width: 100%;
                height: 100%;
                display: flex;
            }
            /* Mobile view: Hide/show logic */
            #app-container.chat-view-active > div:first-child { display: none; }
            #app-container.chat-view-active > div:last-child { display: flex; }
            #app-container:not(.chat-view-active) > div:first-child { display: flex; }
            #app-container:not(.chat-view-active) > div:last-child { display: none; }
            
            /* Ensure back button is visible and correctly placed */
            #chat-header {
                display: flex;
                align-items: center;
                justify-content: flex-start;
            }
            #back-button {
                display: block; /* Make sure it's a block element */
                margin-right: 0.5rem; /* Adjust margin */
            }
        }

        /* Default desktop view */
        @media (min-width: 768px) {
            body {
                display: flex;
                align-items: center;
                justify-content: center;
            }
            #app-container {
                 max-height: 95vh;
            }
            #app-container > div:first-child { display: flex !important; }
            #app-container > div:last-child { display: flex !important; }
            #back-button { display: none; }
        }
    </style>
</head>
<body>

    <!-- Theme toggling script to prevent flash of unstyled content (FOUC) -->
    <script>
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 dark:bg-[#111B21] dark:bg-opacity-75 flex items-center justify-center z-50">
        <div class="spinner"></div>
        <p class="ml-4 text-lg text-gray-700 dark:text-gray-300">Loading FalconixTalk...</p>
    </div>

    <!-- Login Screen -->
    <div id="auth-container" class="hidden bg-white dark:bg-[#202C33] p-8 rounded-xl shadow-2xl max-w-md w-full text-center">
        <h2 class="text-3xl font-extrabold mb-8 text-[#128C7E] dark:text-[#25D366]">Welcome to FalconixTalk</h2>
        <button id="google-sign-in-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-6 rounded-full font-semibold flex items-center justify-center space-x-3 shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300">
            <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M12.24 10.285V11.69h4.293c-.083.486-.31.887-.697 1.25-.388.363-.88.62-1.476.777l-1.63 1.26c-1.02.79-2.288 1.25-3.69 1.25-2.822 0-5.207-1.92-5.99-4.502H3.96c.86 2.09 2.536 3.73 4.67 4.67 2.134.94 4.54.94 6.674 0l1.63-1.26c.596-.157 1.088-.414 1.476-.777.387-.363.614-.764.697-1.25V10.285h-4.293zM12 4c1.365 0 2.61.46 3.63 1.23l2.87-2.87C16.29 2.51 14.19 2 12 2 8.78 2 5.86 3.24 3.96 5.33l1.83 1.42C6.46 4.92 8.94 4 12 4z"/></svg>
            <span>Sign in with Google</span>
        </button>
        <p id="auth-message" class="mt-6 text-red-600 dark:text-red-400 font-medium"></p>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="hidden flex w-full max-w-7xl bg-white dark:bg-[#202C33] shadow-2xl rounded-xl overflow-hidden">
        <!-- Sidebar -->
        <div class="w-full md:w-1/3 bg-[#F0F2F5] dark:bg-[#111B21] border-r border-gray-200 dark:border-gray-700 flex flex-col">
            <!-- Sidebar Header -->
            <div class="p-4 bg-[#128C7E] dark:bg-[#202C33] text-white flex items-center justify-between shadow-md">
                <h1 class="text-xl md:text-2xl font-bold">FalconixTalk</h1>
                <div class="flex items-center space-x-2 md:space-x-3">
                    <button id="theme-toggle-button" class="p-2 rounded-full text-white hover:bg-[#075E54] dark:hover:bg-[#2A3942] focus:outline-none transition-colors">
                        <svg id="theme-toggle-dark-icon" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                        <svg id="theme-toggle-light-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.121-3.536a1 1 0 010 1.414l-.707.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM10 18a1 1 0 01-1-1v-1a1 1 0 112 0v1a1 1 0 01-1 1zM4.95 15.464l-.707-.707a1 1 0 00-1.414 1.414l.707.707a1 1 0 001.414-1.414zM2.75 10.5a1 1 0 011.414 0l.707.707a1 1 0 01-1.414 1.414l-.707-.707a1 1 0 010-1.414zM4.54 4.54a1 1 0 010 1.414l-.707.707a1 1 0 11-1.414-1.414L3.828 3.12a1 1 0 011.414 0z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                    </button>
                    <div class="flex items-center space-x-2 group relative">
                        <label for="profile-picture-upload" class="cursor-pointer">
                            <img id="user-profile-pic" src="https://placehold.co/40x40/cccccc/ffffff?text=U" alt="Profile" class="w-8 h-8 md:w-10 md:h-10 rounded-full border-2 border-white object-cover shadow-sm">
                            <input type="file" id="profile-picture-upload" accept="image/*" class="hidden">
                        </label>
                        <span class="text-xs md:text-sm font-medium truncate" id="current-user-display-name"></span>
                    </div>
                    <button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 md:px-3 rounded-md text-xs md:text-sm font-semibold shadow-sm">Logout</button>
                </div>
            </div>
            <!-- Search Bar -->
            <div class="p-4 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-[#202C33] shadow-sm">
                <div class="relative flex items-center">
                    <input type="text" id="user-search-input" placeholder="Search by name or email" class="w-full p-2.5 pr-10 rounded-lg bg-gray-100 dark:bg-[#2A3942] border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-[#25D366] transition duration-200">
                    <button id="search-button" class="absolute right-0 top-0 h-full px-3 text-gray-500 hover:text-green-500 dark:hover:text-green-400">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path></svg>
                    </button>
                </div>
            </div>
            <!-- User/Chat List -->
            <div id="user-list" class="flex-grow overflow-y-auto chat-list"></div>
        </div>

        <!-- Chat Area -->
        <div class="flex-grow flex flex-col w-full md:w-2/3 chat-area-bg">
            <!-- Chat Header -->
            <div id="chat-header" class="p-4 bg-[#128C7E] dark:bg-[#202C33] text-white flex items-center border-b border-gray-300 dark:border-gray-700 shadow-md">
                <button id="back-button" class="text-white p-2 rounded-full hover:bg-[#075E54] dark:hover:bg-[#2A3942] transition duration-200 focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                </button>
                <div class="flex items-center min-w-0">
                    <img id="chat-partner-pic" src="https://placehold.co/40x40/cccccc/ffffff?text=U" alt="Partner Profile" class="w-10 h-10 rounded-full object-cover mr-3 flex-shrink-0">
                    <div class="min-w-0">
                        <h2 id="chat-header-name" class="text-xl font-semibold dark:text-gray-200 truncate">Select a Chat</h2>
                        <p id="chat-partner-status" class="text-sm text-gray-200 dark:text-gray-400 truncate"></p>
                    </div>
                </div>
            </div>
            <!-- Messages -->
            <div id="messages-container" class="flex-grow p-4 overflow-y-auto chat-messages flex flex-col-reverse space-y-2"></div>
            <!-- Message Input -->
            <div class="p-4 bg-gray-100 dark:bg-[#202C33] border-t border-gray-300 dark:border-gray-700 flex items-center space-x-2 shadow-inner">
                <input type="text" id="message-input" placeholder="Type a message..." class="flex-grow p-3 rounded-full bg-white dark:bg-[#2A3942] border border-gray-300 dark:border-gray-600 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-[#25D366] transition duration-200" disabled>
                <button id="send-button" class="bg-[#25D366] hover:bg-[#128C7E] dark:hover:bg-green-600 text-white p-3 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-[#25D366]" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Main Application Logic -->
    <script type="module">
        // Import Firebase services
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, setDoc, doc, getDoc, updateDoc, orderBy, getDocs, increment } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-storage.js";

        // --- Your Specific Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCVwo7WrXXr9UfGGB2PuMkb7BUpRTHYFdw",
            authDomain: "falconixtalk.firebaseapp.com",
            projectId: "falconixtalk",
            storageBucket: "falconixtalk.appspot.com",
            messagingSenderId: "47917184525",
            appId: "1:47917184525:web:489538a823b2ce50e98744",
            measurementId: "G-GGQCH7PTCE"
        };
        
        // --- CRITICAL: Firestore Security Rules ---
        // You MUST update your rules in the Firebase Console for messaging to work.
        // Go to Firestore -> Rules, delete everything, and paste this:
        /*

        */

        // Global variables
        const appId = firebaseConfig.projectId;
        let app, db, auth, storage;
        let userId, userName, userEmail, userProfilePicUrl;
        let selectedChatPartnerId = null;
        let unsubscribeMessages = null;
        let unsubscribePartnerStatus = null;
        let allUsersCache = []; // Cache for all users to enable searching
        let chatListListener = null; // To manage the chat list subscription
        let unreadCountsListener = null; // Listener for unread counts
        let unreadCounts = {}; // Local cache for unread counts

        // DOM Elements
        const loadingOverlay = document.getElementById('loading-overlay');
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const googleSignInButton = document.getElementById('google-sign-in-button');
        const authMessage = document.getElementById('auth-message');
        const messagesContainer = document.getElementById('messages-container');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const userList = document.getElementById('user-list');
        const chatHeaderName = document.getElementById('chat-header-name');
        const chatPartnerStatus = document.getElementById('chat-partner-status');
        const chatPartnerPic = document.getElementById('chat-partner-pic');
        const logoutButton = document.getElementById('logout-button');
        const userSearchInput = document.getElementById('user-search-input');
        const searchButton = document.getElementById('search-button');
        const userProfilePic = document.getElementById('user-profile-pic');
        const profilePictureUpload = document.getElementById('profile-picture-upload');
        const currentUserDisplayName = document.getElementById('current-user-display-name');
        const backButton = document.getElementById('back-button');
        const themeToggleButton = document.getElementById('theme-toggle-button');
        const darkIcon = document.getElementById('theme-toggle-dark-icon');
        const lightIcon = document.getElementById('theme-toggle-light-icon');
        
        const DEFAULT_PROFILE_PIC = "https://placehold.co/40x40/cccccc/ffffff?text=U";

        // --- Theme Management ---
        const applyTheme = (isDark) => {
            darkIcon.classList.toggle('hidden', isDark);
            lightIcon.classList.toggle('hidden', !isDark);
        };
        applyTheme(document.documentElement.classList.contains('dark'));
        themeToggleButton.addEventListener('click', () => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            applyTheme(isDark);
        });

        // --- Main Initialization ---
        async function main() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app);
                setupAuthListener();
            } catch (error) {
                console.error("Firebase Init Error:", error);
                showMessageBox(`Critical Error: Firebase failed to initialize. Check your config. ${error.message}`, 'error');
                loadingOverlay.classList.add('hidden');
                authContainer.classList.remove('hidden');
            }
        }

        // --- Authentication & User Data Handling ---
        function setupAuthListener() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    await handleUserLogin(user);
                    appContainer.classList.remove('hidden');
                    authContainer.classList.add('hidden');
                } else {
                    handleUserLogout();
                    appContainer.classList.add('hidden');
                    authContainer.classList.remove('hidden');
                }
                loadingOverlay.classList.add('hidden');
            });
        }
        
        async function handleUserLogin(user) {
            userId = user.uid;
            userName = user.displayName;
            userEmail = user.email;

            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}`);
            const userDocSnap = await getDoc(userDocRef);
            
            if (!userDocSnap.exists()) {
                userProfilePicUrl = user.photoURL || DEFAULT_PROFILE_PIC;
                await setDoc(userDocRef, { uid: userId, displayName: userName, email: userEmail, profilePictureUrl: userProfilePicUrl, online: true, lastSeen: serverTimestamp() });
            } else {
                const userData = userDocSnap.data();
                userProfilePicUrl = userData.profilePictureUrl || DEFAULT_PROFILE_PIC;
                await updateDoc(userDocRef, { online: true, lastSeen: serverTimestamp() });
            }
            
            updateUIForUser();
            await fetchAllUsersForSearch();
            listenToUnreadCounts();
            listenToChatList();
            selectChat('public-chat', 'Public Chat', "https://placehold.co/40x40/4CAF50/ffffff?text=GC", false);
        }

        function handleUserLogout() {
            if (userId) {
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}`);
                updateDoc(userDocRef, { online: false, lastSeen: serverTimestamp() });
            }
            userId = null;
            if (unsubscribeMessages) unsubscribeMessages();
            if (unsubscribePartnerStatus) unsubscribePartnerStatus();
            if (chatListListener) chatListListener();
            if (unreadCountsListener) unreadCountsListener();
            updateUIForGuest();
        }

        googleSignInButton.addEventListener('click', () => {
            signInWithPopup(auth, new GoogleAuthProvider()).catch(error => {
                console.error("Google Sign-In Error:", error);
                showMessageBox(`Sign-in failed: ${error.message}`, 'error');
            });
        });

        logoutButton.addEventListener('click', () => signOut(auth));

        // --- UI Updates ---
        function updateUIForUser() {
            currentUserDisplayName.textContent = userName || userEmail;
            userProfilePic.src = userProfilePicUrl;
        }

        function updateUIForGuest() {
            currentUserDisplayName.textContent = '';
            userProfilePic.src = DEFAULT_PROFILE_PIC;
            userList.innerHTML = '';
            messagesContainer.innerHTML = '';
            chatHeaderName.textContent = 'Select a Chat';
            chatPartnerStatus.textContent = '';
            chatPartnerPic.src = DEFAULT_PROFILE_PIC;
            messageInput.disabled = true;
            sendButton.disabled = true;
        }

        // --- User & Chat Management ---
        async function fetchAllUsersForSearch() {
            try {
                const usersRef = collection(db, `artifacts/${appId}/users`);
                const snapshot = await getDocs(query(usersRef));
                allUsersCache = snapshot.docs.map(doc => doc.data()).filter(u => u.uid !== userId);
                console.log(`Successfully fetched and cached ${allUsersCache.length} users for searching.`);
            } catch (error) {
                console.error("Error fetching users for search cache:", error);
                showMessageBox("Could not load user list for searching. Please check your connection or app permissions.", "error");
            }
        }
        
        function listenToUnreadCounts() {
            if (unreadCountsListener) unreadCountsListener();
            const unreadRef = collection(db, `artifacts/${appId}/users/${userId}/unreadCounts`);
            unreadCountsListener = onSnapshot(unreadRef, (snapshot) => {
                unreadCounts = {};
                snapshot.forEach(doc => {
                    unreadCounts[doc.id] = doc.data().count;
                });
                if (userSearchInput.value.trim() === '') {
                    listenToChatList();
                }
            });
        }

        function listenToChatList() {
            if (chatListListener) chatListListener();

            const chatListRef = collection(db, `artifacts/${appId}/users/${userId}/chats`);
            const q = query(chatListRef, orderBy('lastMessageTimestamp', 'desc'));

            chatListListener = onSnapshot(q, (snapshot) => {
                const chatPartners = snapshot.docs.map(doc => doc.data());
                if (userSearchInput.value.trim() === '') {
                    displayChatList(chatPartners);
                }
            });
        }

        function displayChatList(partners) {
            userList.innerHTML = '';
            userList.appendChild(createChatListItem({ uid: 'public-chat', displayName: 'Public Chat', profilePictureUrl: "https://placehold.co/40x40/4CAF50/ffffff?text=GC", statusText: 'Chat with everyone!' }));
            if (partners.length === 0) {
                 const placeholder = document.createElement('div');
                 placeholder.className = "p-4 text-center text-sm text-gray-500 dark:text-gray-400";
                 placeholder.textContent = "Search for users to start a new chat.";
                 userList.appendChild(placeholder);
            } else {
                partners.forEach(partner => {
                    const fullPartnerData = allUsersCache.find(u => u.uid === partner.uid) || {};
                    const statusText = fullPartnerData.online ? `<span class="text-[#25D366] font-medium">Online</span>` : `<span class="text-gray-500 dark:text-gray-400">${formatLastSeen(fullPartnerData.lastSeen)}</span>`;
                    const count = unreadCounts[partner.uid] || 0;
                    userList.appendChild(createChatListItem({ ...partner, statusText, unreadCount: count }));
                });
            }
        }
        
        function displaySearchResults(results) {
            userList.innerHTML = '';
            userList.appendChild(createChatListItem({ uid: 'public-chat', displayName: 'Public Chat', profilePictureUrl: "https://placehold.co/40x40/4CAF50/ffffff?text=GC", statusText: 'Chat with everyone!' }));
            if (results.length === 0) {
                 const placeholder = document.createElement('div');
                 placeholder.className = "p-4 text-center text-sm text-gray-500 dark:text-gray-400";
                 placeholder.textContent = "No users found.";
                 userList.appendChild(placeholder);
            } else {
                results.forEach(user => {
                    const statusText = user.online ? `<span class="text-[#25D366] font-medium">Online</span>` : `<span class="text-gray-500 dark:text-gray-400">${formatLastSeen(user.lastSeen)}</span>`;
                    userList.appendChild(createChatListItem({ ...user, statusText }));
                });
            }
        }

        async function performSearch() {
            if (allUsersCache.length === 0) {
                console.log("User cache is empty. Attempting to re-fetch before searching...");
                await fetchAllUsersForSearch();
            }
            const searchTerm = userSearchInput.value.trim().toLowerCase();
            if (searchTerm === '') {
                listenToChatList();
            } else {
                if (chatListListener) chatListListener();
                const filtered = allUsersCache.filter(user => user.displayName.toLowerCase().includes(searchTerm) || user.email.toLowerCase().includes(searchTerm));
                displaySearchResults(filtered);
            }
        }

        searchButton.addEventListener('click', performSearch);
        userSearchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        function createChatListItem(userData) {
            const item = document.createElement('div');
            item.className = 'chat-list-item p-4 border-b border-gray-200 dark:border-gray-800 bg-white dark:bg-transparent cursor-pointer hover:bg-gray-100 dark:hover:bg-[#2A3942] transition duration-150 ease-in-out flex items-center space-x-3';
            if (selectedChatPartnerId === userData.uid) {
                item.classList.add('bg-[#E0F2F1]', 'dark:bg-[#2A3942]', 'font-bold');
            }
            
            const unreadBadge = userData.unreadCount > 0 
                ? `<span class="ml-auto bg-green-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">${userData.unreadCount}</span>`
                : '';

            item.innerHTML = `
                <img src="${userData.profilePictureUrl || DEFAULT_PROFILE_PIC}" alt="Profile" class="w-10 h-10 rounded-full object-cover flex-shrink-0">
                <div class="min-w-0 flex-grow">
                    <div class="font-semibold text-gray-800 dark:text-gray-200 truncate">${userData.displayName}</div>
                    <div class="text-sm text-gray-500 dark:text-gray-400 truncate">${userData.statusText || ''}</div>
                </div>
                ${unreadBadge}`;
            item.addEventListener('click', () => selectChat(userData.uid, userData.displayName, userData.profilePictureUrl));
            return item;
        }

        async function selectChat(partnerId, partnerName, partnerPic, activateChatView = true) {
            if (selectedChatPartnerId === partnerId && appContainer.classList.contains('chat-view-active')) return;

            selectedChatPartnerId = partnerId;
            
            if (unsubscribeMessages) unsubscribeMessages();
            if (unsubscribePartnerStatus) unsubscribePartnerStatus();

            chatHeaderName.textContent = partnerName;
            chatPartnerPic.src = partnerPic || DEFAULT_PROFILE_PIC;
            
            messagesContainer.innerHTML = '';
            messageInput.disabled = false;
            sendButton.disabled = false;
            
            if (userSearchInput.value.trim() === '') {
                listenToChatList();
            } else {
                performSearch();
            }
            
            if (partnerId === 'public-chat') {
                chatPartnerStatus.textContent = 'Everyone is here';
            } else {
                const unreadCountRef = doc(db, `artifacts/${appId}/users/${userId}/unreadCounts/${partnerId}`);
                await setDoc(unreadCountRef, { count: 0 });

                const partnerDocRef = doc(db, `artifacts/${appId}/users/${partnerId}`);
                unsubscribePartnerStatus = onSnapshot(partnerDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        chatPartnerStatus.textContent = data.online ? 'Online' : formatLastSeen(data.lastSeen);
                    }
                });
            }
            
            setupRealtimeMessages();

            if (window.innerWidth < 768 && activateChatView) {
                appContainer.classList.add('chat-view-active');
            }
        }

        // --- Messaging ---
        function getPrivateChatId(uid1, uid2) {
            return uid1 < uid2 ? `${uid1}_${uid2}` : `${uid2}_${uid1}`;
        }

        function setupRealtimeMessages() {
            let messagesRef;
            if (selectedChatPartnerId === 'public-chat') {
                messagesRef = collection(db, `artifacts/${appId}/public/data/messages`);
            } else {
                const chatId = getPrivateChatId(userId, selectedChatPartnerId);
                messagesRef = collection(db, `chats/${chatId}/messages`);
            }
            
            const q = query(messagesRef, orderBy('timestamp', 'desc'));
            unsubscribeMessages = onSnapshot(q, (snapshot) => {
                messagesContainer.innerHTML = '';
                snapshot.docs.forEach(doc => displayMessage(doc.data()));
            });
        }
        
        async function sendMessage() {
            const text = messageInput.value.trim();
            if (text === '' || !userId) return;

            if (selectedChatPartnerId !== 'public-chat') {
                const myChatListRef = doc(db, `artifacts/${appId}/users/${userId}/chats/${selectedChatPartnerId}`);
                const partnerChatListRef = doc(db, `artifacts/${appId}/users/${selectedChatPartnerId}/chats/${userId}`);
                const partnerUnreadCountRef = doc(db, `artifacts/${appId}/users/${selectedChatPartnerId}/unreadCounts/${userId}`);

                const chatDoc = await getDoc(myChatListRef);

                if (!chatDoc.exists()) {
                    const partnerInfo = allUsersCache.find(u => u.uid === selectedChatPartnerId);
                    if (partnerInfo) {
                        await setDoc(myChatListRef, { uid: partnerInfo.uid, displayName: partnerInfo.displayName, profilePictureUrl: partnerInfo.profilePictureUrl, lastMessageTimestamp: serverTimestamp() });
                        await setDoc(partnerChatListRef, { uid: userId, displayName: userName, profilePictureUrl: userProfilePicUrl, lastMessageTimestamp: serverTimestamp() });
                    }
                } else {
                    await updateDoc(myChatListRef, { lastMessageTimestamp: serverTimestamp() });
                    await updateDoc(partnerChatListRef, { lastMessageTimestamp: serverTimestamp() });
                }
                
                await setDoc(partnerUnreadCountRef, { count: increment(1) }, { merge: true });
            }
            
            const messageData = { senderId: userId, senderDisplayName: userName, text: text, timestamp: serverTimestamp() };
            let messagesRef;
            if (selectedChatPartnerId === 'public-chat') {
                messagesRef = collection(db, `artifacts/${appId}/public/data/messages`);
            } else {
                const chatId = getPrivateChatId(userId, selectedChatPartnerId);
                messagesRef = collection(db, `chats/${chatId}/messages`);
            }
            
            try {
                await addDoc(messagesRef, messageData);
                messageInput.value = '';
            } catch (error) {
                console.error("Send Message Error:", error);
                showMessageBox(`Could not send message: ${error.message}`, 'error');
            }
        }

        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        function displayMessage(data) {
            const isSender = data.senderId === userId;
            const msgDiv = document.createElement('div');
            msgDiv.className = `flex items-end p-2.5 my-1 rounded-xl shadow-sm max-w-[80%] md:max-w-[70%] animate-fade-in
                ${isSender ? 'bg-[#DCF8C6] dark:bg-[#005C4B] self-end rounded-br-none' : 'bg-white dark:bg-[#202C33] self-start rounded-bl-none'}
                ${isSender ? 'flex-row-reverse' : ''}`;
            
            const senderUser = isSender ? { displayName: 'You' } : allUsersCache.find(u => u.uid === data.senderId) || { displayName: 'Unknown User' };

            msgDiv.innerHTML = `
                <div class="flex flex-col ${isSender ? 'items-end' : 'items-start'} min-w-0">
                    <div class="font-semibold text-xs mb-0.5 text-gray-800 dark:text-gray-200 truncate">${senderUser.displayName}</div>
                    <p class="break-words text-sm text-gray-800 dark:text-gray-200">${data.text}</p>
                    <div class="text-right text-xs text-gray-500 dark:text-gray-400 mt-0.5">
                        ${data.timestamp ? new Date(data.timestamp.toDate()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'Sending...'}
                    </div>
                </div>`;
            messagesContainer.appendChild(msgDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // --- Utility Functions ---
        function formatLastSeen(timestamp) {
            if (!timestamp) return 'Offline';
            const date = timestamp.toDate();
            const diff = new Date() - date;
            const minutes = Math.floor(diff / 60000);
            if (minutes < 1) return 'Online';
            if (minutes < 60) return `last seen ${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `last seen ${hours}h ago`;
            return `last seen on ${date.toLocaleDateString()}`;
        }

        function showMessageBox(message, type = 'info') {
            const box = document.createElement('div');
            box.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100]';
            const bgColor = type === 'error' ? 'bg-red-500' : 'bg-[#25D366]';
            box.innerHTML = `
                <div class="bg-white dark:bg-[#2A3942] p-6 rounded-lg shadow-xl max-w-sm text-center">
                    <p class="text-lg font-semibold mb-4 ${type === 'error' ? 'text-red-700 dark:text-red-400' : 'text-gray-800 dark:text-gray-200'}">${message}</p>
                    <button id="msg-box-ok" class="${bgColor} hover:opacity-80 text-white px-4 py-2 rounded-md">OK</button>
                </div>`;
            document.body.appendChild(box);
            box.querySelector('#msg-box-ok').onclick = () => document.body.removeChild(box);
        }
        
        // Back button for mobile
        backButton.addEventListener('click', () => {
            appContainer.classList.remove('chat-view-active');
            selectedChatPartnerId = null; 
            
            if (unsubscribeMessages) unsubscribeMessages();
            if (unsubscribePartnerStatus) unsubscribePartnerStatus();

            chatHeaderName.textContent = 'Select a Chat';
            chatPartnerStatus.textContent = '';
            chatPartnerPic.src = DEFAULT_PROFILE_PIC;
            messagesContainer.innerHTML = '';
            messageInput.disabled = true;
            sendButton.disabled = true;

            listenToChatList();
        });

        // Start the application
        main();
    </script>
</body>
</html>
